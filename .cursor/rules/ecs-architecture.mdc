# ECSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®Œå…¨ç§»è¡Œãƒ«ãƒ¼ãƒ«

## ğŸ¯ **åŸºæœ¬åŸå‰‡**

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯**å®Œå…¨ãªECSï¼ˆEntity-Component-Systemï¼‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã¸ã®ç§»è¡Œã‚’ç›®æ¨™ã¨ã—ã€å¾“æ¥ã®OOPãƒ™ãƒ¼ã‚¹ã®è¨­è¨ˆã‹ã‚‰è„±å´ã—ã¾ã™ã€‚

### **ECSã®3ã¤ã®æ ¸å¿ƒè¦ç´ **

1. **Entityï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰**: ç´”ç²‹ãªIDã®ã¿ã€ãƒ‡ãƒ¼ã‚¿ã‚„ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒãŸãªã„
2. **Componentï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰**: ç´”ç²‹ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã¾ãªã„
3. **Systemï¼ˆã‚·ã‚¹ãƒ†ãƒ ï¼‰**: ç‰¹å®šã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å‡¦ç†ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯

## ğŸš« **ç¦æ­¢äº‹é …**

### **1. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç›´æ¥ç®¡ç†**
```typescript
// âŒ ç¦æ­¢: ç¾åœ¨ã®å®Ÿè£…
export class BaseGameEntity {
    public components: Component[]; // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç›´æ¥ç®¡ç†
}

// âœ… æ¨å¥¨: ç´”ç²‹ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
export interface Entity {
    id: string; // IDã®ã¿
}
```

### **2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚ã‚‹**
```typescript
// âŒ ç¦æ­¢: ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export abstract class BaseComponent {
    abstract execute(context: GameContext): ComponentResult; // ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚€
}

// âœ… æ¨å¥¨: ç´”ç²‹ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ 
export interface Component {
    id: string;
    type: ComponentType;
    data: ComponentData; // ãƒ‡ãƒ¼ã‚¿ã®ã¿
}
```

### **3. ã‚·ã‚¹ãƒ†ãƒ ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç›´æ¥æ“ä½œ**
```typescript
// âŒ ç¦æ­¢: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç›´æ¥æ“ä½œ
export class CombatSystem {
    executeAttack(params: AttackParams): CombatResult {
        // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç›´æ¥æ“ä½œ
    }
}

// âœ… æ¨å¥¨: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®å‡¦ç†
export class CombatSystem {
    process(entities: Entity[], components: ComponentMap): void {
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®å‡¦ç†
    }
}
```

## âœ… **å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³**

### **1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¨­è¨ˆ**

#### **ç´”ç²‹ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ **
```typescript
// ä½ç½®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export interface PositionComponent {
    x: number;
    y: number;
}

// ç§»å‹•ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export interface MovementComponent {
    distance: number;
    directions: Direction[];
    restrictions: string[];
}

// ç”Ÿå‘½å€¤ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export interface HealthComponent {
    maxHealth: number;
    currentHealth: number;
}
```

#### **SoAï¼ˆStructure of Arraysï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¡ç”¨**
```typescript
// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã®SoA
export const Position = {
    x: new Float64Array(10000),  // xåº§æ¨™ã®é…åˆ—
    y: new Float64Array(10000)   // yåº§æ¨™ã®é…åˆ—
}

// ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®SoA
export const Position = {
    x: [] as number[],
    y: [] as number[]
}
```

### **2. ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…**

#### **ã‚¯ã‚¨ãƒªãƒ™ãƒ¼ã‚¹ã®å‡¦ç†**
```typescript
export class MovementSystem extends EntitySystem {
    constructor() {
        super(Matcher.all(PositionComponent, VelocityComponent));
    }
    
    protected process(entities: Entity[]): void {
        for (const entity of entities) {
            const position = entity.getComponent(PositionComponent)!;
            const velocity = entity.getComponent(VelocityComponent)!;
            
            // ä½ç½®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
            position.x += velocity.x * Time.deltaTime;
            position.y += velocity.y * Time.deltaTime;
        }
    }
}
```

#### **ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†**
```typescript
export class ExampleSystem extends EntitySystem {
    protected onInitialize() {
        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–æ™‚ã®å‡¦ç†
        const eventBus = this.scene.entityManager.eventBus;
        eventBus.on('someEvent', this.handleEvent, { context: this });
    }
    
    protected onBegin() {
        // ãƒ•ãƒ¬ãƒ¼ãƒ é–‹å§‹æ™‚ã®å‡¦ç†
        this.frameCounter++;
    }
    
    protected process(entities: Entity[]) {
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
        for (const entity of entities) {
            this.processEntity(entity);
        }
    }
    
    protected lateProcess(entities: Entity[]) {
        // å¾Œå‡¦ç†
        this.handlePostProcessing();
    }
    
    protected onEnd() {
        // ãƒ•ãƒ¬ãƒ¼ãƒ çµ‚äº†æ™‚ã®å‡¦ç†
        this.updateStatistics();
    }
}
```

### **3. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç®¡ç†**

#### **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ä½¿ç”¨**
```typescript
export class ComponentManager {
    private entityComponents: Map<string, Map<ComponentType, Component>> = new Map();
    
    addComponent(entityId: string, component: Component): void
    getComponent(entityId: string, type: ComponentType): Component | undefined
    getComponentsByType(type: ComponentType): Component[]
    removeComponent(entityId: string, type: ComponentType): boolean
}
```

#### **Archetypeã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥**
```typescript
// åŒã˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ„ã¿åˆã‚ã›ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
const movableArchetype = [Position, Velocity, !Frozen];
const movableEntities = archetypeSystem.getEntities(movableArchetype);
// ç›´æ¥å‡¦ç†ã€å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ä¸è¦
```

## ğŸš€ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**

### **1. ã‚¯ã‚¨ãƒªã‚·ã‚¹ãƒ†ãƒ ã®æœ€é©åŒ–**
```typescript
// âŒ éåŠ¹ç‡: ç·šå½¢æ¤œç´¢ O(n)
function findEntitiesWithHealth() {
    const result = [];
    for (const entity of allEntities) {
        if (entity.hasComponent(HealthComponent)) {
            result.push(entity);
        }
    }
    return result;
}

// âœ… åŠ¹ç‡: ã‚¯ã‚¨ãƒªã‚·ã‚¹ãƒ†ãƒ  O(1)
const entitiesWithHealth = entityManager.query()
    .withAll(HealthComponent)
    .execute(); // ç›´æ¥å–å¾—ã€SparseSetè‡ªå‹•æœ€é©åŒ–
```

### **2. ãƒãƒƒãƒæ“ä½œ**
```typescript
// åŠ¹ç‡çš„ãªãƒãƒƒãƒä½œæˆ
const entities = scene.createEntities(10000, "Bullets");

// ãƒãƒƒãƒã‚¯ã‚¨ãƒªæœ€é©åŒ–
const movingEntities = scene.querySystem
    .queryAll(PositionComponent, VelocityComponent)
    .entities;
```

### **3. ä¸¦åˆ—å‡¦ç†**
```typescript
// ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
const runner = new ParallelJobRunner(Environment.ProcessorCount);
const store = new EntityStore { JobRunner = runner };

const queryJob = query.ForEach((myComponents, entities) => {
    // å…¨åˆ©ç”¨å¯èƒ½ã‚³ã‚¢ã§ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å®Ÿè¡Œ
    for (int n = 0; n < entities.Length; n++) {
        myComponents[n].value += 10;
    }
});
queryJob.RunParallel();
```

## ğŸ”§ **å®Ÿè£…æ™‚ã®åˆ¶ç´„äº‹é …**

### **1. æ§‹é€ å¤‰æ›´ã®åˆ¶ç´„**
```typescript
// âŒ ç¦æ­¢: ã‚¯ã‚¨ãƒªãƒ«ãƒ¼ãƒ—å†…ã§ã®æ§‹é€ å¤‰æ›´
query.ForEachEntity((ref Position position, Entity entity) => {
    // StructuralChangeExceptionãŒç™ºç”Ÿ
    entity.AddComponent(new EntityName("test"));
});

// âœ… è§£æ±º: CommandBufferã®ä½¿ç”¨
var buffer = store.GetCommandBuffer();
query.ForEachEntity((ref Position position, Entity entity) => {
    buffer.AddComponent(entity.Id, new EntityName("test"));
});
buffer.Playback(); // ãƒ«ãƒ¼ãƒ—çµ‚äº†å¾Œã«é©ç”¨
```

### **2. ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ **
```typescript
// å‹å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
enum GameEvents {
    PLAYER_DIED = 'player:died',
    LEVEL_COMPLETED = 'level:completed'
}

// ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºè¡Œã¨è³¼èª­
eventBus.emit(GameEvents.PLAYER_DIED, { playerId: 123 });
eventBus.on(GameEvents.PLAYER_DIED, (data) => {
    // dataã®å‹ãŒè‡ªå‹•æ¨è«–ã•ã‚Œã‚‹
});
```

## ğŸ“‹ **ç§»è¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

### **Phase 1: åŸºç›¤ã®å†æ§‹ç¯‰**
- [ ] ç´”ç²‹ãªECSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å®Ÿè£…
- [ ] ãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ã‚¸ãƒƒã‚¯ã®å®Œå…¨åˆ†é›¢
- [ ] Archetypeã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥
- [ ] ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®å®Ÿè£…

### **Phase 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
- [ ] SoAãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¡ç”¨
- [ ] ã‚¯ã‚¨ãƒªã‚·ã‚¹ãƒ†ãƒ ã®æœ€é©åŒ–
- [ ] ä¸¦åˆ—å‡¦ç†ã®å°å…¥
- [ ] ãƒãƒƒãƒæ“ä½œã®å®Ÿè£…

### **Phase 3: é«˜åº¦ãªæ©Ÿèƒ½**
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
- [ ] ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¦³å¯Ÿã‚·ã‚¹ãƒ†ãƒ 
- [ ] ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŒæœŸæ©Ÿèƒ½

## ğŸ® **å…·ä½“çš„ãªå®Ÿè£…ä¾‹**

### **2Dãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒãƒ¼ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
```typescript
export interface HealthComponent {
    maxHealth: number;
    currentHealth: number;
}

export interface AnimationComponent {
    currentAnimation: string;
    frameIndex: number;
    frameTime: number;
}

export interface PhysicsComponent {
    mass: number;
    friction: number;
    isGrounded: boolean;
}
```

### **ã‚·ãƒ¼ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **
```typescript
export class GameScene extends Scene {
    public initialize() {
        this.setupEntities();
        this.setupSystems();
    }
    
    private setupSystems() {
        // å®Ÿè¡Œé †åºã‚’æ˜ç¢ºã«åˆ¶å¾¡
        this.addEntityProcessor(new PlayerInputSystem()).updateOrder = 0;
        this.addEntityProcessor(new MovementSystem()).updateOrder = 10;
        this.addEntityProcessor(new AISystem()).updateOrder = 15;
        this.addEntityProcessor(new CollisionSystem()).updateOrder = 30;
        this.addEntityProcessor(new RenderSystem()).updateOrder = 100;
    }
}
```

## ğŸ“š **å‚è€ƒè³‡æ–™**

- [ES Engine ECS Framework](https://github.com/esengine/ecs-framework) - TypeScript ECSãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- [Friflo ECS](https://github.com/friflo/ecs-wiki) - é«˜æ€§èƒ½C# ECSãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- [bitECS](https://github.com/natethegreatt/bitecs) - è»½é‡TypeScript ECSãƒ©ã‚¤ãƒ–ãƒ©ãƒª

## âš ï¸ **æ³¨æ„äº‹é …**

1. **æ®µéšçš„ç§»è¡Œ**: æ—¢å­˜æ©Ÿèƒ½ã‚’å£Šã•ãªã„ã‚ˆã†æ®µéšçš„ã«ç§»è¡Œã™ã‚‹
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š**: å„æ®µéšã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¸¬å®šã—ã€æ”¹å–„ã‚’ç¢ºèªã™ã‚‹
3. **ãƒ†ã‚¹ãƒˆé§†å‹•**: æ–°æ©Ÿèƒ½ã¯å¿…ãšãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã‹ã‚‰å®Ÿè£…ã™ã‚‹
4. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**: å®Ÿè£…ã¨ä¸¦è¡Œã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹

ã“ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã†ã“ã¨ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å®Œå…¨ãªECSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ç§»è¡Œã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ä¿å®ˆæ€§ã€æ‹¡å¼µæ€§ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚
description:
globs:
alwaysApply: true
---
